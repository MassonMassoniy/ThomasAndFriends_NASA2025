<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <title>Will it rain on my parade?</title>
    <style>
        body {
            background-size: cover;
            background-image: url('/images/index_background3.jpg');
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            min-height: 100vh;
        }
        .heading {
            text-align: center;
            font-size: 2.5rem;
            color: #222;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            font-weight: bold;
        }
        .main-card {
            max-width: 700px;
            margin: 2rem auto;
            background: rgba(255,255,255,0.95);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            border: 1.5px solid #e5e7eb;
            padding: 2.5rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .map-container {
            border-radius: 20px;
            border: 2px solid #e5e7eb;
            background: #f9fafb;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
        }
        .input {
            display: flex;
            gap: 1rem;
            width: 100%;
            justify-content: center;
        }
        input[type="date"], input[type="text"] {
            border-radius: 12px;
            border: 1.5px solid #e5e7eb;
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            background: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
            transition: border-color 0.2s;
        }
        input[type="date"]:focus, input[type="text"]:focus {
            border-color: #a3a3a3;
            outline: none;
        }
        .button-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button {
            border-radius: 12px;
            border: 1.5px solid #e5e7eb;
            background: #ffffff;
            color: #222;
            font-size: 1.25rem;
            padding: 0.75rem 2.5rem;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            transition: background 0.2s;
        }
        button:hover {
            background: #e5e5e5;
        }
        @media (max-width: 800px) {
            .main-card {
                max-width: 98vw;
                padding: 1rem 0.5rem;
            }
            .map-container {
                width: 98vw !important;
                height: 300px !important;
            }
            .input {
                flex-direction: column;
                gap: 1rem;
            }
        }
        .leaflet-control-geocoder-icon { /* Mangifying glass icon */
            margin: auto;
            position: relative;
        }

        .leaflet-bar{
            display: flex;
            align-items: center;
            display: grid;
            align-content: center;
            grid-template-columns: auto auto;
        }
        .leaflet-control-geocoder-alternatives{
            grid-column-start: 2;
        }

    </style>
</head>
<body>
    <h1 class="heading">Please select location and date:</h1>
    <div class="main-card">
        <div style="width: 100%; height: 350px; position: relative;" class="map-container" id="map"></div>
        <div class="input-container">
            <div class="input">
                <input type="text" id="address" name="address" placeholder="Coordinates">
                <input type="date" id="date" name="date">
            </div>
        </div>
        <div class="button-container">
            <button type="submit" onclick="submitAddressAndDate()">Will it rain on my parade?</button>
        </div>
    </div>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
</body>
<!-- ...existing scripts... -->

<!-- Script for map-->
<script type="module">

    var map = L.map('map').setView([51.505, -0.09], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

        let marker = null;
        let selectedLatitude = null;
        let selectedLongitude = null;

        // Geocoder control
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            collapsed: true,
            position: "topright"
        })
        .on('markgeocode', function(e) {
            const latlng = e.geocode.center;
            selectedLatitude = latlng.lat;
            selectedLongitude = latlng.lng;
            console.log(latlng);

            // Update hidden inputs
            document.getElementById("lat").value = selectedLatitude;
            document.getElementById("lng").value = selectedLongitude;

            // Update visible input
            document.getElementById("address").value = e.geocode.name;

            // Drop or move marker
            if (marker) {
                marker.setLatLng(latlng);
            } else {
                marker = L.marker(latlng).addTo(map);
            }

            // Center map
            map.setView(latlng, 13);
        })
        .addTo(map);

        function onMapClick(e) {
            console.log(e.latlng);
            document.getElementById("lat").value = e.latlng.lat;
            document.getElementById("lng").value = e.latlng.lng;

            document.getElementById("address").value = `${e.latlng.lat.toFixed(5)}; ${e.latlng.lng.toFixed(5)}`;
            const { lat, lng } = e.latlng;

            // If marker already exists, move it; otherwise create it
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }

            // Store coords in variables
            let selectedLatitude;
            let selectedLongitude;
            selectedLatitude = lat;
            selectedLongitude = lng;
        }

    map.on('click', onMapClick);
</script>

<script>
    function submitAddressAndDate(){
        var date = document.getElementById("date").value;
        date = date.replaceAll("-", "");
        console.log(date);
        var lat = document.getElementById("lat").value;
        var lng = document.getElementById("lng").value;

        if (date && lat && lng){
            window.location.href = `https://drmy-server-fast.tail8afd19.ts.net/?latitude=${lat}&longitude=${lng}&date=${date}`;
        } else if (!date){
            alert("Enter the date!")
        }
    }
</script>

<!-- Script to save the date in a variable -->
<script>
    const dateInput = document.querySelector('input[type="date"]');
    let selectedDate = null;
    dateInput.addEventListener('change', function () {
        selectedDate = this.value;
        console.log("Selected date:", selectedDate);
    });
</script>
</html>